---
phase: 03-schema-graphrag
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - agent-brain-server/agent_brain_server/indexing/graph_index.py
  - agent-brain-server/agent_brain_server/services/query_service.py
  - agent-brain-server/agent_brain_server/models/query.py
  - agent-brain-server/agent_brain_server/api/routers/query.py
  - agent-brain-server/tests/unit/test_graph_index.py
  - agent-brain-server/tests/unit/test_graph_models.py
  - agent-brain-server/tests/integration/test_graph_query.py
autonomous: true

must_haves:
  truths:
    - "Graph queries can be filtered by entity types (e.g., only Class and Function)"
    - "Graph queries can be filtered by relationship types (e.g., only calls and extends)"
    - "API accepts entity_types and relationship_types filter parameters"
    - "Unfiltered queries still work exactly as before"
    - "Type filtering returns subset of unfiltered results"
    - "All existing tests still pass"
  artifacts:
    - path: "agent-brain-server/agent_brain_server/indexing/graph_index.py"
      provides: "GraphIndexManager.query_by_type() method with entity/relationship filtering"
      contains: "def query_by_type"
    - path: "agent-brain-server/agent_brain_server/services/query_service.py"
      provides: "QueryService._execute_graph_query() updated to pass entity_types/relationship_types filters"
      contains: "entity_types"
    - path: "agent-brain-server/agent_brain_server/models/query.py"
      provides: "QueryRequest with optional entity_types and relationship_types fields"
      contains: "entity_types"
    - path: "agent-brain-server/tests/unit/test_graph_index.py"
      provides: "Tests for query_by_type with filtering"
      contains: "test_query_by_type"
  key_links:
    - from: "agent-brain-server/agent_brain_server/services/query_service.py"
      to: "agent-brain-server/agent_brain_server/indexing/graph_index.py"
      via: "QueryService calls graph_index_manager.query_by_type()"
      pattern: "query_by_type"
    - from: "agent-brain-server/agent_brain_server/models/query.py"
      to: "agent-brain-server/agent_brain_server/services/query_service.py"
      via: "QueryRequest.entity_types passed through to graph query"
      pattern: "request\\.entity_types"
    - from: "agent-brain-server/agent_brain_server/indexing/graph_index.py"
      to: "agent-brain-server/agent_brain_server/models/graph.py"
      via: "Imports ENTITY_TYPES and RELATIONSHIP_TYPES for validation"
      pattern: "from agent_brain_server\\.models\\.graph import.*ENTITY_TYPES"
---

<objective>
Add entity type and relationship type filtering to graph queries (SCHEMA-04).

Purpose: Enable users to narrow graph query results by entity types (e.g., "show me only Class and Function entities") and relationship types (e.g., "show me only calls and extends relationships"). This makes the knowledge graph more useful for targeted code analysis.

Output: Updated query API with entity_types/relationship_types filter parameters, GraphIndexManager.query_by_type() method, and comprehensive tests.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-schema-graphrag/03-RESEARCH.md
@.planning/phases/03-schema-graphrag/03-01-SUMMARY.md
@agent-brain-server/agent_brain_server/indexing/graph_index.py
@agent-brain-server/agent_brain_server/services/query_service.py
@agent-brain-server/agent_brain_server/models/query.py
@agent-brain-server/agent_brain_server/api/routers/query.py
@agent-brain-server/tests/unit/test_graph_index.py
@agent-brain-server/tests/integration/test_graph_query.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add query_by_type to GraphIndexManager and wire into QueryService</name>
  <files>
    agent-brain-server/agent_brain_server/indexing/graph_index.py
    agent-brain-server/agent_brain_server/services/query_service.py
    agent-brain-server/agent_brain_server/models/query.py
    agent-brain-server/agent_brain_server/api/routers/query.py
  </files>
  <action>
**1. GraphIndexManager (graph_index.py) — add `query_by_type()` method:**

Add a new method to GraphIndexManager that wraps the existing `query()` method with post-filtering:

```python
def query_by_type(
    self,
    query_text: str,
    entity_types: list[str] | None = None,
    relationship_types: list[str] | None = None,
    top_k: int = 10,
    traversal_depth: int = 2,
) -> list[dict[str, Any]]:
    """Query graph filtered by entity and/or relationship types.

    Fetches extra results from the base query, then filters by
    entity types and relationship types before returning top_k.

    Args:
        query_text: Natural language query.
        entity_types: Filter to results involving these entity types
            (matches against subject_type or object_type).
        relationship_types: Filter to results with these predicates.
        top_k: Maximum results to return after filtering.
        traversal_depth: Graph traversal depth.

    Returns:
        Filtered list of result dicts.
    """
```

Implementation:
- If no filters, delegate directly to `self.query(query_text, top_k, traversal_depth)` (no overhead)
- If filters provided, over-fetch: call `self.query(query_text, top_k=top_k * 3, traversal_depth=traversal_depth)` to get a larger candidate set
- Filter by entity_types: keep result if `result.get("subject_type")` or `result.get("object_type")` is in entity_types (case-insensitive comparison using normalize_entity_type on both sides)
- Filter by relationship_types: keep result if `result.get("predicate")` is in relationship_types (lowercase comparison)
- Return filtered[:top_k]
- Log filter stats: how many before/after filtering

Import `normalize_entity_type` and `ENTITY_TYPES`, `RELATIONSHIP_TYPES` from `agent_brain_server.models.graph`.

IMPORTANT: The existing `_find_entity_relationships()` method currently builds result dicts that include "subject", "predicate", "object", "source_chunk_id" but NOT "subject_type" or "object_type". Update `_find_entity_relationships()` to also include these type fields from the triplet data:
```python
result = {
    "entity": entity,
    "subject": self._get_triplet_field(triplet, "subject", ""),
    "subject_type": self._get_triplet_field(triplet, "subject_type", None),  # NEW
    "predicate": self._get_triplet_field(triplet, "predicate", ""),
    "object": self._get_triplet_field(triplet, "object", ""),
    "object_type": self._get_triplet_field(triplet, "object_type", None),  # NEW
    "source_chunk_id": self._get_triplet_field(triplet, "source_chunk_id", None),
    "relationship_path": self._format_relationship_path(triplet),
    "graph_score": 1.0,
}
```

**2. QueryRequest (models/query.py) — add filter fields:**

Add two new optional fields to `QueryRequest`:

```python
# Graph entity type filtering (Feature 122 - Schema GraphRAG)
entity_types: list[str] | None = Field(
    default=None,
    description="Filter graph results by entity types (e.g., ['Class', 'Function']). "
                "Only applies to graph and multi query modes.",
    examples=[["Class", "Function"], ["Package", "Module"]],
)
relationship_types: list[str] | None = Field(
    default=None,
    description="Filter graph results by relationship types (e.g., ['calls', 'extends']). "
                "Only applies to graph and multi query modes.",
    examples=[["calls", "extends"], ["imports", "contains"]],
)
```

**3. QueryService (query_service.py) — wire filters through:**

Update `_execute_graph_query()` to use the new filter fields. Check if `request` has `entity_types` or `relationship_types` (use getattr with None default for backward compat with test mocks):

```python
entity_types = getattr(request, 'entity_types', None)
relationship_types = getattr(request, 'relationship_types', None)

if entity_types or relationship_types:
    graph_results = self.graph_index_manager.query_by_type(
        query_text=request.query,
        entity_types=entity_types,
        relationship_types=relationship_types,
        top_k=request.top_k,
        traversal_depth=traversal_depth,
    )
else:
    graph_results = self.graph_index_manager.query(
        query_text=request.query,
        top_k=request.top_k,
        traversal_depth=traversal_depth,
    )
```

Also update `_execute_multi_query()` to pass entity_types/relationship_types when calling `_execute_graph_query()` — since it creates its own request, it already passes the original request object through.

In `_execute_graph_query()`, also need to pass `entity_types`/`relationship_types` when constructing `QueryRequest` for the stage1 request in `execute_query()`. Add these fields to the stage1_request construction in `execute_query()`:
```python
stage1_request = QueryRequest(
    query=request.query,
    top_k=stage1_top_k,
    similarity_threshold=request.similarity_threshold,
    mode=request.mode,
    alpha=request.alpha,
    source_types=request.source_types,
    languages=request.languages,
    file_paths=request.file_paths,
    entity_types=request.entity_types,      # Pass through
    relationship_types=request.relationship_types,  # Pass through
)
```

**4. API router (query.py) — no changes needed.** The QueryRequest model already flows through to the service layer. The new fields will be automatically available in the OpenAPI schema since they are on QueryRequest.
  </action>
  <verify>
```bash
cd agent-brain-server && poetry run python -c "
from agent_brain_server.models.query import QueryRequest
# Verify new fields exist and are optional
req = QueryRequest(query='test')
assert req.entity_types is None
assert req.relationship_types is None

# Verify fields accept values
req2 = QueryRequest(query='test', entity_types=['Class', 'Function'], relationship_types=['calls'])
assert req2.entity_types == ['Class', 'Function']
assert req2.relationship_types == ['calls']

# Verify GraphIndexManager has query_by_type
from agent_brain_server.indexing.graph_index import GraphIndexManager
assert hasattr(GraphIndexManager, 'query_by_type')

print('All API and method checks passed')
" && poetry run ruff check agent_brain_server && poetry run mypy agent_brain_server
```
  </verify>
  <done>
GraphIndexManager.query_by_type() method exists with entity_types and relationship_types filtering. QueryRequest has optional entity_types and relationship_types fields. QueryService._execute_graph_query() wires filters through to graph index manager. _find_entity_relationships() includes subject_type and object_type in results. Lint and type checking pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for type filtering and run full quality gate</name>
  <files>
    agent-brain-server/tests/unit/test_graph_index.py
    agent-brain-server/tests/unit/test_graph_models.py
    agent-brain-server/tests/integration/test_graph_query.py
  </files>
  <action>
**In test_graph_index.py**, add a new test class `TestQueryByType` (or add methods to existing test class if one exists for querying):

1. `test_query_by_type_no_filters` — call query_by_type without entity_types or relationship_types, verify it returns same results as query() (delegates through)
2. `test_query_by_type_entity_filter` — set up a GraphIndexManager with mock graph_store containing triplets with mixed subject_types ("Class", "Function", "Module"). Call query_by_type with entity_types=["Class"] and verify only results with subject_type or object_type == "Class" are returned.
3. `test_query_by_type_relationship_filter` — set up triplets with mixed predicates ("calls", "imports", "extends"). Call query_by_type with relationship_types=["calls"] and verify only "calls" results returned.
4. `test_query_by_type_combined_filters` — filter on both entity_types and relationship_types simultaneously
5. `test_query_by_type_empty_after_filter` — filter with entity_types that match nothing, verify empty list returned
6. `test_query_by_type_disabled` — verify returns empty list when ENABLE_GRAPH_INDEX is False

Use the existing test patterns: mock settings with `@patch`, create GraphStoreManager and GraphIndexManager instances, add triplets via the _MinimalGraphStore pattern. Check the existing test_graph_index.py for patterns.

**In test_graph_models.py** (if not already done in Plan 01 tests), add a test for QueryRequest with new fields:
1. `test_query_request_entity_types_field` — verify QueryRequest accepts entity_types
2. `test_query_request_relationship_types_field` — verify QueryRequest accepts relationship_types
3. `test_query_request_defaults_none` — verify both default to None

**In test_graph_query.py** (integration), add a test:
1. `test_graph_query_with_type_filter` — if there's an existing integration pattern, add a test that exercises the type filter through the QueryService layer. If no suitable pattern exists, skip this and add a note.

After writing tests, run the full quality gate:
```bash
cd /Users/richardhightower/clients/spillwave/src/agent-brain && task before-push
```

Then run `task pr-qa-gate` to verify coverage:
```bash
cd /Users/richardhightower/clients/spillwave/src/agent-brain && task pr-qa-gate
```
  </action>
  <verify>
```bash
cd /Users/richardhightower/clients/spillwave/src/agent-brain && task before-push
```
Exit code must be 0. All tests pass, including new type filtering tests.
  </verify>
  <done>
6+ new tests for query_by_type filtering in test_graph_index.py. QueryRequest field tests in test_graph_models.py. All tests pass. `task before-push` exits 0. `task pr-qa-gate` exits 0. Coverage maintained above 50%.
  </done>
</task>

</tasks>

<verification>
1. `task before-push` passes (format, lint, typecheck, tests)
2. `task pr-qa-gate` passes (coverage gate)
3. `poetry run pytest tests/unit/test_graph_index.py tests/unit/test_graph_models.py -v` shows all new and existing tests passing
4. GraphIndexManager.query_by_type() exists and filters correctly
5. QueryRequest accepts entity_types and relationship_types parameters
6. API endpoint at POST /query accepts the new filter fields in request body
7. Unfiltered graph queries return same results as before (no regression)
</verification>

<success_criteria>
- SCHEMA-04: Entity type filtering works in graph queries
- SCHEMA-04: Relationship type filtering works in graph queries
- API accepts entity_types and relationship_types on QueryRequest
- Unfiltered queries return identical results to before (backward compatible)
- All existing tests pass unchanged
- `task before-push` and `task pr-qa-gate` both exit 0
</success_criteria>

<output>
After completion, create `.planning/phases/03-schema-graphrag/03-02-SUMMARY.md`
</output>
