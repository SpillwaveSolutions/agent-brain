---
phase: 04-provider-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agent-brain-server/pyproject.toml
  - e2e/integration/conftest.py
  - e2e/integration/test_provider_openai.py
  - e2e/integration/test_provider_anthropic.py
  - e2e/integration/test_provider_cohere.py
  - e2e/integration/test_provider_ollama.py
  - e2e/integration/test_health_providers.py
  - e2e/fixtures/config_anthropic.yaml
autonomous: true

must_haves:
  truths:
    - "OpenAI provider config loads and provider instantiates correctly (TEST-01)"
    - "Anthropic summarization provider config loads and provider instantiates correctly (TEST-02)"
    - "Ollama provider config loads, no API keys needed, and live tests work when Ollama running (TEST-03)"
    - "Cohere provider config loads and provider instantiates correctly (TEST-04)"
    - "/health/providers endpoint returns structured status for all configured providers (TEST-05)"
    - "Tests skip gracefully when required API keys or services are unavailable"
  artifacts:
    - path: "e2e/integration/test_provider_openai.py"
      provides: "OpenAI provider E2E test suite"
      min_lines: 80
    - path: "e2e/integration/test_provider_anthropic.py"
      provides: "Anthropic provider E2E test suite"
      min_lines: 60
    - path: "e2e/integration/test_provider_cohere.py"
      provides: "Cohere provider E2E test suite"
      min_lines: 80
    - path: "e2e/integration/test_provider_ollama.py"
      provides: "Extended Ollama provider E2E test suite"
      min_lines: 60
    - path: "e2e/integration/test_health_providers.py"
      provides: "Health providers endpoint E2E test suite"
      min_lines: 60
    - path: "e2e/fixtures/config_anthropic.yaml"
      provides: "Anthropic-focused config fixture"
      contains: "provider: anthropic"
  key_links:
    - from: "e2e/integration/test_provider_openai.py"
      to: "e2e/fixtures/config_openai.yaml"
      via: "AGENT_BRAIN_CONFIG env var"
      pattern: "config_openai\\.yaml"
    - from: "e2e/integration/test_provider_cohere.py"
      to: "e2e/fixtures/config_cohere.yaml"
      via: "AGENT_BRAIN_CONFIG env var"
      pattern: "config_cohere\\.yaml"
    - from: "e2e/integration/test_health_providers.py"
      to: "agent-brain-server/agent_brain_server/api/routers/health.py"
      via: "HTTP GET /health/providers"
      pattern: "health.*providers"
---

<objective>
Create per-provider E2E test suites for OpenAI, Anthropic, Ollama, and Cohere, plus an E2E test for the /health/providers endpoint.

Purpose: Validate that each provider combination works end-to-end (config loading, provider instantiation, optional live API calls) and that the health endpoint accurately reports provider status. This covers TEST-01 through TEST-05.

Output: 5 new test files, 1 new config fixture, updated pytest markers in pyproject.toml
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-provider-integration-testing/04-RESEARCH.md
@e2e/integration/conftest.py
@e2e/integration/test_ollama_offline.py
@e2e/integration/test_provider_switching.py
@e2e/fixtures/config_openai.yaml
@e2e/fixtures/config_cohere.yaml
@e2e/fixtures/config_ollama_only.yaml
@agent-brain-server/agent_brain_server/providers/base.py
@agent-brain-server/agent_brain_server/providers/factory.py
@agent-brain-server/agent_brain_server/config/provider_config.py
@agent-brain-server/agent_brain_server/api/routers/health.py
@agent-brain-server/agent_brain_server/models/health.py
@agent-brain-server/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pytest markers and create Anthropic config fixture</name>
  <files>
    agent-brain-server/pyproject.toml
    e2e/fixtures/config_anthropic.yaml
  </files>
  <action>
1. In `agent-brain-server/pyproject.toml`, add new pytest markers to the existing `[tool.pytest.ini_options]` markers list:
   - `openai: marks tests that require OPENAI_API_KEY`
   - `anthropic: marks tests that require ANTHROPIC_API_KEY`
   - `cohere: marks tests that require COHERE_API_KEY`
   Keep the existing `ollama` and `slow` markers.

2. Create `e2e/fixtures/config_anthropic.yaml` -- a config fixture focused on Anthropic summarization with default OpenAI embeddings:
   ```yaml
   # Anthropic provider configuration for E2E testing
   # Tests Anthropic summarization with OpenAI embeddings (default combo)
   embedding:
     provider: openai
     model: text-embedding-3-large
     api_key_env: OPENAI_API_KEY

   summarization:
     provider: anthropic
     model: claude-haiku-4-5-20251001
     api_key_env: ANTHROPIC_API_KEY
   ```
   This is the default/most common configuration. It validates ANTHROPIC_API_KEY works for summarization.
  </action>
  <verify>
Check file exists: `ls e2e/fixtures/config_anthropic.yaml`
Check markers: `grep -A 10 'markers' agent-brain-server/pyproject.toml` shows openai, anthropic, cohere markers.
Run: `cd /Users/richardhightower/clients/spillwave/src/agent-brain/agent-brain-server && poetry run pytest --markers | grep -E 'openai|anthropic|cohere|ollama'` shows all 4 provider markers.
  </verify>
  <done>
pyproject.toml has openai, anthropic, cohere, ollama markers. config_anthropic.yaml exists with correct provider settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create per-provider E2E test suites and health endpoint test</name>
  <files>
    e2e/integration/test_provider_openai.py
    e2e/integration/test_provider_anthropic.py
    e2e/integration/test_provider_cohere.py
    e2e/integration/test_provider_ollama.py
    e2e/integration/test_health_providers.py
    e2e/integration/conftest.py
  </files>
  <action>
Follow the established patterns from test_ollama_offline.py and test_provider_switching.py. Each provider test file should:
- Import from agent_brain_server.config.provider_config (clear_settings_cache, load_provider_settings, validate_provider_config)
- Import from agent_brain_server.providers.base (EmbeddingProviderType, SummarizationProviderType)
- Import from agent_brain_server.providers.factory (ProviderRegistry)
- Use temp_project_dir fixture pattern (creates temp dir with .claude/agent-brain/)
- Use clear_config_cache autouse fixture
- Copy appropriate YAML fixture to temp project's config path
- Use os.chdir() pattern to set CWD for config discovery (with try/finally cleanup)

**IMPORTANT:** After creating all files, add helper fixtures to `e2e/integration/conftest.py`:
- Add `check_openai_key` session fixture: skips if OPENAI_API_KEY not set
- Add `check_anthropic_key` session fixture: skips if ANTHROPIC_API_KEY not set
- Add `check_cohere_key` session fixture: skips if COHERE_API_KEY not set
These supplement the existing `check_api_key` fixture. Do NOT modify the existing `check_api_key` fixture.

**test_provider_openai.py (TEST-01):**
- Mark entire module with `pytestmark = pytest.mark.openai`
- TestOpenAIConfiguration class:
  - test_openai_config_loads_correctly: Load config_openai.yaml, verify provider=openai, model=text-embedding-3-large
  - test_openai_requires_api_key: Verify config validation reports CRITICAL error if OPENAI_API_KEY not set (temporarily unset it with patch.dict)
  - test_openai_provider_instantiates: Load config, get embedding provider from ProviderRegistry, verify provider_name=="OpenAI", dimensions==3072
- TestOpenAILiveIntegration class (skip if OPENAI_API_KEY not set):
  - test_openai_embedding_returns_vector: Generate embedding for "Hello, world!", verify list of floats, len==3072
  - test_openai_embedding_batch: Generate embeddings for ["Hello", "World"], verify 2 vectors each with 3072 dims
  Use `asyncio.get_event_loop().run_until_complete()` pattern from test_ollama_offline.py.

**test_provider_anthropic.py (TEST-02):**
- Mark entire module with `pytestmark = pytest.mark.anthropic`
- TestAnthropicConfiguration class:
  - test_anthropic_config_loads_correctly: Load config_anthropic.yaml, verify summarization.provider=anthropic, model matches
  - test_anthropic_requires_api_key: Verify config validation reports CRITICAL error if ANTHROPIC_API_KEY not set
  - test_anthropic_provider_instantiates: Get summarization provider from ProviderRegistry, verify provider_name is "Anthropic"
- TestAnthropicLiveIntegration class (skip if ANTHROPIC_API_KEY not set):
  - test_anthropic_summarization_returns_text: Summarize a short code snippet, verify non-empty string returned
  Use `asyncio.get_event_loop().run_until_complete()` pattern.

**test_provider_cohere.py (TEST-04):**
- Mark entire module with `pytestmark = pytest.mark.cohere`
- TestCohereConfiguration class:
  - test_cohere_config_loads_correctly: Load config_cohere.yaml, verify provider=cohere, model=embed-english-v3.0
  - test_cohere_requires_api_key: Verify config validation reports CRITICAL error if COHERE_API_KEY not set
  - test_cohere_provider_instantiates: Get embedding provider from ProviderRegistry, verify provider_name=="Cohere"
  - test_cohere_dimensions: Verify provider.get_dimensions() returns 1024 (embed-english-v3.0 dimensions)
- TestCohereLiveIntegration class (skip if COHERE_API_KEY not set):
  - test_cohere_embedding_returns_vector: Generate embedding, verify list of floats with len==1024

**test_provider_ollama.py (TEST-03):**
This is a NEW file that extends test_ollama_offline.py with additional Ollama-specific E2E tests. Do NOT modify test_ollama_offline.py.
- Mark entire module with `pytestmark = pytest.mark.ollama`
- Import is_ollama_running from test_ollama_offline
- TestOllamaRerankerConfig class:
  - test_ollama_reranker_config_loads: Load config_ollama_only.yaml, verify reranker.provider=ollama, reranker.model=llama3.2
  - test_ollama_full_stack_no_api_keys: Load config_ollama_only.yaml, verify embedding, summarization, and reranker all have no API key needed
- TestOllamaProviderRegistry class:
  - test_ollama_embedding_in_registry: Verify "ollama" in ProviderRegistry.get_available_embedding_providers()
  - test_ollama_summarization_in_registry: Verify "ollama" in ProviderRegistry.get_available_summarization_providers()
- TestOllamaLiveFullStack class (skip if Ollama not running):
  - test_ollama_embedding_and_summarization_together: Use config_ollama_only.yaml, generate embedding AND summarization in one test to verify full offline stack

**test_health_providers.py (TEST-05):**
This tests the /health/providers endpoint. Use the FastAPI TestClient pattern (not subprocess server).
- Import TestClient from fastapi.testclient
- Import the FastAPI app: `from agent_brain_server.api.main import create_app` (or however the app is created -- check main.py first)
- Since the health.providers endpoint uses request.app.state, we need to set up a minimal app state. Use unittest.mock to mock app.state attributes (vector_store, strict_mode, etc.)
- TestHealthProvidersEndpoint class:
  - test_providers_endpoint_returns_200: GET /health/providers, verify 200 response
  - test_providers_response_has_required_fields: Verify response has config_source, strict_mode, validation_errors, providers, timestamp
  - test_providers_lists_embedding_and_summarization: Verify providers list has entries with provider_type "embedding" and "summarization"
  - test_providers_reports_status_for_each: Verify each provider entry has status field (healthy or unavailable)
  - test_providers_embedding_includes_dimensions: Verify embedding provider entry has dimensions field when healthy

IMPORTANT: For test_health_providers.py, look at how existing tests in agent-brain-server/tests/integration/test_api.py set up the TestClient and mock app state. Follow that pattern exactly. If the app needs app.state.vector_store and app.state.job_service, mock those as needed.

All test files must pass Black formatting (88 char lines), Ruff linting, and mypy type checking. Use Google-style docstrings. Add type hints to all function signatures.
  </action>
  <verify>
Run from agent-brain-server directory:
```bash
cd /Users/richardhightower/clients/spillwave/src/agent-brain/agent-brain-server
poetry run black --check ../e2e/integration/test_provider_openai.py ../e2e/integration/test_provider_anthropic.py ../e2e/integration/test_provider_cohere.py ../e2e/integration/test_provider_ollama.py ../e2e/integration/test_health_providers.py
```

Run the tests that don't require API keys (config tests only):
```bash
cd /Users/richardhightower/clients/spillwave/src/agent-brain/agent-brain-server
poetry run pytest ../e2e/integration/test_provider_openai.py::TestOpenAIConfiguration -v
poetry run pytest ../e2e/integration/test_provider_anthropic.py::TestAnthropicConfiguration -v
poetry run pytest ../e2e/integration/test_provider_cohere.py::TestCohereConfiguration -v
poetry run pytest ../e2e/integration/test_provider_ollama.py -v
poetry run pytest ../e2e/integration/test_health_providers.py -v
```

Run `task before-push` to verify nothing is broken.
  </verify>
  <done>
All 5 provider test files exist. Configuration tests pass without API keys. Health endpoint tests pass. Tests with API key requirements skip gracefully when keys unavailable. `task before-push` passes.
  </done>
</task>

</tasks>

<verification>
1. All new test files exist and pass Black/Ruff formatting
2. Configuration tests run without any API keys (test config loading only)
3. Live integration tests skip gracefully with clear messages when API keys missing
4. Health providers endpoint returns structured response with provider status
5. `task before-push` passes (existing tests not broken)
6. `poetry run pytest ../e2e/integration/test_provider_*.py ../e2e/integration/test_health_providers.py -v` runs and reports test results
</verification>

<success_criteria>
- 5 new test files created covering TEST-01 through TEST-05
- Config fixture for Anthropic exists
- Pytest markers (openai, anthropic, cohere) registered in pyproject.toml
- All configuration-level tests pass without API keys
- Health endpoint tests pass with mocked app state
- `task before-push` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/04-provider-integration-testing/04-01-SUMMARY.md`
</output>
