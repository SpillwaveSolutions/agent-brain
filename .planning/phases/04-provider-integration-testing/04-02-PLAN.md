---
phase: 04-provider-integration-testing
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .github/workflows/provider-e2e.yml
  - docs/PROVIDER_CONFIGURATION.md
autonomous: true

must_haves:
  truths:
    - "GitHub Actions workflow exists that runs provider E2E tests with matrix strategy (TEST-06)"
    - "CI skips provider tests when API keys are missing without failing the build"
    - "Provider configuration documentation covers all 4 providers with setup instructions"
    - "Documentation includes environment variable reference for each provider"
    - "Documentation includes example config.yaml files for common provider combinations"
  artifacts:
    - path: ".github/workflows/provider-e2e.yml"
      provides: "CI workflow for provider E2E test matrix"
      contains: "strategy"
    - path: "docs/PROVIDER_CONFIGURATION.md"
      provides: "Verified provider configuration reference"
      min_lines: 100
  key_links:
    - from: ".github/workflows/provider-e2e.yml"
      to: "e2e/integration/test_provider_openai.py"
      via: "pytest -m marker execution"
      pattern: "pytest.*-m"
    - from: "docs/PROVIDER_CONFIGURATION.md"
      to: "e2e/fixtures/config_openai.yaml"
      via: "documentation references"
      pattern: "config_openai"
---

<objective>
Create CI workflow for provider E2E test matrix and comprehensive provider configuration documentation.

Purpose: Enable automated CI testing of provider combinations (skipping when API keys unavailable) and provide developers with verified, up-to-date provider setup documentation (TEST-06).

Output: GitHub Actions workflow file, provider configuration documentation
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-provider-integration-testing/04-RESEARCH.md
@.planning/phases/04-provider-integration-testing/04-01-SUMMARY.md
@.github/workflows/pr-qa-gate.yml
@e2e/fixtures/config_openai.yaml
@e2e/fixtures/config_cohere.yaml
@e2e/fixtures/config_ollama_only.yaml
@e2e/fixtures/config_ollama.yaml
@e2e/fixtures/config_anthropic.yaml
@agent-brain-server/agent_brain_server/providers/base.py
@agent-brain-server/agent_brain_server/config/provider_config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions provider E2E workflow</name>
  <files>.github/workflows/provider-e2e.yml</files>
  <action>
Create a new GitHub Actions workflow file at `.github/workflows/provider-e2e.yml` for provider E2E testing. This is SEPARATE from the existing pr-qa-gate.yml (which handles unit tests, lint, typecheck).

The workflow should:

1. **Trigger:** Only on push to main/develop OR when PR has label `test-providers`. This prevents expensive API calls on every PR.
   ```yaml
   on:
     push:
       branches: [main, develop]
     pull_request:
       types: [labeled]
   ```
   Add a job-level `if` condition: `if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'test-providers')`

2. **Matrix strategy:** Test each provider separately:
   - openai: uses config_openai.yaml, requires OPENAI_API_KEY + ANTHROPIC_API_KEY, runs tests marked `openai`
   - anthropic: uses config_anthropic.yaml, requires OPENAI_API_KEY + ANTHROPIC_API_KEY, runs tests marked `anthropic`
   - cohere: uses config_cohere.yaml, requires COHERE_API_KEY + ANTHROPIC_API_KEY, runs tests marked `cohere`
   - ollama: uses config_ollama_only.yaml, requires no API keys but needs Ollama service, runs tests marked `ollama`

   Use `fail-fast: false` so one provider failure doesn't block others.
   Use `max-parallel: 2` to limit concurrent API usage.

3. **Steps for each matrix job:**
   a. Checkout code
   b. Set up Python 3.11
   c. Install Poetry (same pattern as pr-qa-gate.yml)
   d. Cache Poetry dependencies (same pattern as pr-qa-gate.yml)
   e. Install server dependencies: `cd agent-brain-server && poetry install`
   f. Check required API keys (shell step that sets output `skip=true/false`)
   g. Run provider tests (conditional on skip output):
      ```bash
      cd agent-brain-server
      AGENT_BRAIN_CONFIG=../e2e/fixtures/$CONFIG_FILE poetry run pytest ../e2e/integration/ -m $MARKER -v --tb=short
      ```
   h. For the ollama matrix entry, add an Ollama service container or skip if not available

4. **API key check step pattern:**
   ```yaml
   - name: Check required API keys
     id: check_keys
     run: |
       MISSING=""
       for key in $REQUIRED_KEYS; do
         if [ -z "${!key}" ]; then
           MISSING="$MISSING $key"
         fi
       done
       if [ -n "$MISSING" ]; then
         echo "Missing keys:$MISSING - skipping $PROVIDER tests"
         echo "skip=true" >> $GITHUB_OUTPUT
       else
         echo "skip=false" >> $GITHUB_OUTPUT
       fi
     env:
       OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
       ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
       COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
       REQUIRED_KEYS: ${{ matrix.required_keys }}
       PROVIDER: ${{ matrix.provider }}
   ```

5. **Also add a "config-tests" job** that ALWAYS runs (no API keys needed) and tests all the configuration-level tests:
   ```bash
   cd agent-brain-server
   poetry run pytest ../e2e/integration/test_provider_openai.py::TestOpenAIConfiguration \
     ../e2e/integration/test_provider_anthropic.py::TestAnthropicConfiguration \
     ../e2e/integration/test_provider_cohere.py::TestCohereConfiguration \
     ../e2e/integration/test_provider_ollama.py \
     ../e2e/integration/test_health_providers.py \
     -v --tb=short
   ```
   This job requires NO secrets and validates config loading works.

Use secrets from GitHub repo secrets (referenced as `${{ secrets.OPENAI_API_KEY }}` etc.). Do NOT hardcode any API keys.

For the Ollama matrix entry, use `continue-on-error: true` since Ollama requires a local service that may not be available in CI. Add a comment explaining this.
  </action>
  <verify>
Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/provider-e2e.yml'))"`
Check file structure makes sense: `grep -c 'matrix' .github/workflows/provider-e2e.yml` returns >= 1
Check it references correct test files: `grep 'test_provider' .github/workflows/provider-e2e.yml`
  </verify>
  <done>
provider-e2e.yml exists with matrix strategy for 4 providers, API key checks, conditional test execution, and a config-tests job that always runs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create verified provider configuration documentation</name>
  <files>docs/PROVIDER_CONFIGURATION.md</files>
  <action>
Create `docs/PROVIDER_CONFIGURATION.md` -- a comprehensive provider configuration reference document. This satisfies TEST-06.

Structure the document as follows:

**1. Overview section:**
- Brief explanation of Agent Brain's pluggable provider system
- How config.yaml is discovered (list the 6 search locations from provider_config.py._find_config_file)
- AGENT_BRAIN_CONFIG env var override

**2. Provider Matrix table:**
| Provider | Embeddings | Summarization | Reranking | API Key Env Var |
|----------|-----------|---------------|-----------|-----------------|
| OpenAI | text-embedding-3-large (3072d) | gpt-4o-mini | - | OPENAI_API_KEY |
| Anthropic | - | claude-haiku-4-5-20251001 | - | ANTHROPIC_API_KEY |
| Ollama | nomic-embed-text (768d) | llama3.2 | llama3.2 | (none) |
| Cohere | embed-english-v3.0 (1024d) | - | - | COHERE_API_KEY |
| Gemini | - | gemini-1.5-flash | - | GOOGLE_API_KEY |
| Grok | - | grok-beta | - | XAI_API_KEY |
| SentenceTransformers | - | - | ms-marco-MiniLM-L-6-v2 | (none) |

**3. Configuration Examples section:**
For each common provider combination, show the complete config.yaml content. Reference the actual fixture files in e2e/fixtures/ for verification.

- Default (OpenAI + Anthropic) -- the most common setup
- Fully Offline (Ollama only) -- no API keys needed
- Cohere Embeddings + Anthropic Summarization
- OpenAI with Reranking enabled

**4. Environment Variables section:**
Table of all env vars: OPENAI_API_KEY, ANTHROPIC_API_KEY, COHERE_API_KEY, GOOGLE_API_KEY, XAI_API_KEY, AGENT_BRAIN_CONFIG, AGENT_BRAIN_STRICT_MODE, ENABLE_RERANKING.

For each: description, required for which providers, example value format.

**5. Validation section:**
- How startup validation works (dual-layer: warning + error)
- Strict mode (AGENT_BRAIN_STRICT_MODE=true or --strict flag)
- How to check provider health: `curl http://localhost:8000/health/providers`
- Example /health/providers JSON response
- How to use `agent-brain config show` and `agent-brain config path` for debugging

**6. Troubleshooting section:**
Common issues and solutions:
- "Missing API key" error: Set the required environment variable
- "Dimension mismatch" error: Clear index when switching embedding providers (`agent-brain reset --yes`)
- Ollama not responding: Check `ollama serve` is running, verify model is pulled
- Config not found: Use `agent-brain config path` to see where config is being loaded from

**7. Testing Providers section:**
- How to run provider E2E tests locally
- Which tests require API keys (reference pytest markers)
- How to test a single provider: `poetry run pytest ../e2e/integration/ -m openai -v`
- CI workflow details (reference provider-e2e.yml)

Verify all config examples in the doc match actual fixture file content. Cross-reference provider names, model names, and environment variable names against the source code (provider_config.py, base.py enums).

Keep the doc factual and reference-oriented. No marketing language. Use code blocks for all config examples and commands.
  </action>
  <verify>
Check file exists and has substantial content: `wc -l docs/PROVIDER_CONFIGURATION.md` shows >= 100 lines.
Check key sections exist: `grep -c '##' docs/PROVIDER_CONFIGURATION.md` shows >= 6 section headers.
Check it references all 4 providers: `grep -c 'openai\|anthropic\|ollama\|cohere' docs/PROVIDER_CONFIGURATION.md` shows multiple matches.
Run `task before-push` to verify nothing is broken.
  </verify>
  <done>
PROVIDER_CONFIGURATION.md exists with provider matrix, config examples, env var reference, validation guide, troubleshooting section, and testing instructions. All config examples match actual fixture files and source code.
  </done>
</task>

</tasks>

<verification>
1. `provider-e2e.yml` has valid YAML syntax
2. Workflow uses matrix strategy with 4 providers
3. Workflow has API key check step that sets skip output
4. Workflow has config-tests job that runs without secrets
5. PROVIDER_CONFIGURATION.md covers all providers with correct details
6. Documentation references actual config fixtures and source code
7. `task before-push` passes
</verification>

<success_criteria>
- GitHub Actions workflow for provider E2E tests exists and has valid syntax
- CI config-tests job requires no API keys
- Provider configuration documentation is comprehensive (100+ lines)
- Documentation covers all 4 primary providers plus Gemini, Grok, SentenceTransformers
- All config examples in documentation are verified against actual fixture files
- `task before-push` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/04-provider-integration-testing/04-02-SUMMARY.md`
</output>
