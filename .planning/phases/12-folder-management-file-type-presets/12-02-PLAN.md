---
phase: 12-folder-management-file-type-presets
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - agent-brain-server/agent_brain_server/api/routers/folders.py
  - agent-brain-server/agent_brain_server/api/routers/__init__.py
  - agent-brain-server/agent_brain_server/api/main.py
  - agent-brain-server/agent_brain_server/models/index.py
  - agent-brain-server/agent_brain_server/services/indexing_service.py
  - agent-brain-server/tests/test_folders_api.py
  - agent-brain-server/tests/test_include_types.py
autonomous: true

must_haves:
  truths:
    - "GET /index/folders returns JSON list of indexed folders with path, chunk_count, last_indexed"
    - "DELETE /index/folders removes all chunks for the specified folder and returns count"
    - "DELETE /index/folders rejects removal if active indexing job exists for that folder"
    - "IndexRequest accepts include_types field that expands to glob patterns before DocumentLoader"
    - "include_types and include_patterns can be combined (union of both)"
    - "FolderManager is initialized in server lifespan and wired into app.state"
    - "IndexingService delegates to FolderManager.add_folder on successful indexing"
  artifacts:
    - path: "agent-brain-server/agent_brain_server/api/routers/folders.py"
      provides: "Folders API router with GET and DELETE endpoints"
      exports: ["router"]
    - path: "agent-brain-server/agent_brain_server/api/main.py"
      provides: "FolderManager wired into lifespan and app.state"
      contains: "folder_manager"
    - path: "agent-brain-server/agent_brain_server/models/index.py"
      provides: "IndexRequest with include_types field"
      contains: "include_types"
    - path: "agent-brain-server/agent_brain_server/services/indexing_service.py"
      provides: "IndexingService calls FolderManager.add_folder after successful indexing"
      contains: "folder_manager"
  key_links:
    - from: "agent-brain-server/agent_brain_server/api/routers/folders.py"
      to: "app.state.folder_manager"
      via: "request.app.state dependency injection"
      pattern: "request\\.app\\.state\\.folder_manager"
    - from: "agent-brain-server/agent_brain_server/api/routers/folders.py"
      to: "app.state.storage_backend.delete_by_metadata"
      via: "bulk chunk deletion"
      pattern: "storage_backend.*delete"
    - from: "agent-brain-server/agent_brain_server/services/indexing_service.py"
      to: "FolderManager.add_folder"
      via: "post-indexing folder registration"
      pattern: "folder_manager\\.add_folder"
---

<objective>
Wire FolderManager into the server: create the folders API router (GET/DELETE), integrate FolderManager into server lifespan and IndexingService, and add include_types support to IndexRequest.

Purpose: This makes folder management and file type presets available via the REST API, enabling CLI and plugin access in Plan 03.

Output: Folders API router, updated lifespan, updated IndexingService, updated IndexRequest model, comprehensive API tests.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-folder-management-file-type-presets/12-RESEARCH.md
@.planning/phases/12-folder-management-file-type-presets/12-01-SUMMARY.md

@agent-brain-server/agent_brain_server/api/main.py
@agent-brain-server/agent_brain_server/api/routers/__init__.py
@agent-brain-server/agent_brain_server/api/routers/index.py
@agent-brain-server/agent_brain_server/models/index.py
@agent-brain-server/agent_brain_server/services/indexing_service.py
@agent-brain-server/agent_brain_server/job_queue/job_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create folders API router and wire into server</name>
  <files>
    agent-brain-server/agent_brain_server/api/routers/folders.py
    agent-brain-server/agent_brain_server/api/routers/__init__.py
    agent-brain-server/agent_brain_server/api/main.py
    agent-brain-server/tests/test_folders_api.py
  </files>
  <action>
1. **Create `api/routers/folders.py`** with APIRouter:

   **GET `/` (list folders)** — `async def list_folders(request: Request) -> FolderListResponse`:
   - Get `folder_manager` from `request.app.state.folder_manager`
   - Call `folder_manager.list_folders()`
   - Map FolderRecord objects to FolderInfo models
   - Return FolderListResponse with folders list and total count
   - Summary: "List Indexed Folders", description: "List all folders that have been indexed with chunk counts."

   **DELETE `/` (remove folder)** — `async def remove_folder(request_body: FolderDeleteRequest, request: Request) -> FolderDeleteResponse`:
   - Get `folder_manager` and `job_service` from `request.app.state`
   - Normalize `request_body.folder_path` with `str(Path(folder_path).resolve())`
   - **FOLD-07 check:** Get active jobs from `job_service.get_queue_stats()`. If `stats.running > 0`, query running jobs and check if any job's folder_path matches. If match, raise HTTPException 409 "Cannot remove folder while indexing job is active for this path".
   - Look up folder in FolderManager. If not found, raise HTTPException 404 "Folder not found in index".
   - Get `storage_backend` from `request.app.state.storage_backend`
   - Delete chunks: if folder record has `chunk_ids`, delete by IDs. Otherwise fall back to `delete_by_metadata` with source path prefix filter.
   - For ChromaDB: use collection.delete(ids=chunk_ids) directly via storage_backend
   - Remove folder from FolderManager
   - Return FolderDeleteResponse with folder_path, chunks_deleted count, and success message

   Import FolderInfo, FolderListResponse, FolderDeleteRequest, FolderDeleteResponse from models.folders.

2. **Update `api/routers/__init__.py`** — add `folders_router` export:
   ```python
   from .folders import router as folders_router
   ```

3. **Update `api/main.py`**:
   - Import `folders_router` from routers
   - Add `app.include_router(folders_router, prefix="/index/folders", tags=["Folders"])`
   - In `lifespan()`, after storage backend initialization but before indexing service:
     - Create FolderManager with state_dir (if state_dir is not None) or temp dir
     - Call `await folder_manager.initialize()`
     - Set `app.state.folder_manager = folder_manager`
     - Log "Folder manager initialized"
   - In the IndexingService constructor call, pass `folder_manager=folder_manager` (will be wired in Task 2)
   - On shutdown (after yield), no special cleanup needed for FolderManager (file-based)

4. **Create tests** at `tests/test_folders_api.py`:
   - Use `httpx.AsyncClient` with `app` (or TestClient pattern matching existing test files)
   - Test GET /index/folders returns empty list initially
   - Test GET /index/folders returns folders after indexing (mock FolderManager)
   - Test DELETE /index/folders with valid folder returns success
   - Test DELETE /index/folders with nonexistent folder returns 404
   - Test DELETE /index/folders while job running returns 409 (mock job_service)
   - Mock storage_backend and folder_manager on app.state for isolation
  </action>
  <verify>
cd agent-brain-server && poetry run pytest tests/test_folders_api.py -v && poetry run mypy agent_brain_server/api/routers/folders.py --strict --ignore-missing-imports
  </verify>
  <done>GET /index/folders and DELETE /index/folders endpoints work correctly, folder removal blocked during active jobs, all API tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate FolderManager into IndexingService and add include_types to IndexRequest</name>
  <files>
    agent-brain-server/agent_brain_server/services/indexing_service.py
    agent-brain-server/agent_brain_server/models/index.py
    agent-brain-server/agent_brain_server/api/routers/index.py
    agent-brain-server/tests/test_include_types.py
  </files>
  <action>
1. **Update `models/index.py`** — add `include_types` field to IndexRequest:

   ```python
   include_types: list[str] | None = Field(
       default=None,
       description="File type presets to include (e.g., ['python', 'docs']). "
       "Resolved to glob patterns before indexing. "
       "Can be combined with include_patterns (union of both).",
       examples=[["python", "docs"], ["code"], ["typescript", "web"]],
   )
   ```

   Add to the `model_config` examples to show include_types usage.

2. **Update `services/indexing_service.py`**:

   a. Add `folder_manager` parameter to `__init__`:
   ```python
   def __init__(self, ..., folder_manager: "FolderManager | None" = None, ...):
   ```
   Store as `self.folder_manager = folder_manager`. Use `from __future__ import annotations` for forward reference (FolderManager may not be imported at module level — use lazy import or TYPE_CHECKING).

   b. In `start_indexing()` method, after successful indexing (line ~503 where `self._indexed_folders.add(abs_folder_path)` is), also call:
   ```python
   if self.folder_manager is not None:
       chunk_ids = [chunk.chunk_id for chunk in chunks]
       await self.folder_manager.add_folder(
           folder_path=abs_folder_path,
           chunk_count=len(chunks),
           chunk_ids=chunk_ids,
       )
   ```
   Keep the existing `self._indexed_folders.add(abs_folder_path)` for backward compat.

   c. In the `start_indexing()` method, BEFORE calling `document_loader.load_files()`, resolve include_types to include_patterns:
   ```python
   # Resolve file type presets to glob patterns (FTYPE-03, FTYPE-06)
   effective_include_patterns = list(request.include_patterns or [])
   if request.include_types:
       from agent_brain_server.services.file_type_presets import resolve_file_types
       preset_patterns = resolve_file_types(request.include_types)
       effective_include_patterns.extend(preset_patterns)
       # Deduplicate
       effective_include_patterns = list(set(effective_include_patterns))
   ```
   Pass `effective_include_patterns` (or None if empty) to the document_loader. Check how DocumentLoader.load_files() handles include_patterns — it likely accepts them as a parameter. If not, pass them through the request object by updating the local request copy.

   d. In `reset()`, also call `await self.folder_manager.clear()` if folder_manager is not None.

   e. In `get_status()`, if folder_manager is not None, use `await self.folder_manager.list_folders()` to populate `indexed_folders` instead of (or in addition to) the in-memory `_indexed_folders` set. This ensures persistence across restarts.

3. **Update `api/routers/index.py`** — in the `index_documents` and `add_documents` functions, pass `include_types` through when creating the resolved IndexRequest:
   ```python
   resolved_request = IndexRequest(
       ...,
       include_types=request_body.include_types,
   )
   ```

4. **Create tests** at `tests/test_include_types.py`:
   - Test IndexRequest model accepts include_types field
   - Test IndexRequest model with include_types=None (default)
   - Test IndexRequest model with include_types=["python", "docs"]
   - Test that include_types and include_patterns combine correctly (mock indexing service)
   - Test unknown include_type raises ValueError (via file_type_presets.resolve_file_types)
  </action>
  <verify>
cd agent-brain-server && poetry run pytest tests/test_include_types.py -v && poetry run pytest -x -q && poetry run mypy agent_brain_server/services/indexing_service.py agent_brain_server/models/index.py --strict --ignore-missing-imports
  </verify>
  <done>IndexingService registers folders with FolderManager after indexing, include_types resolves to glob patterns and combines with include_patterns, all tests pass.</done>
</task>

</tasks>

<verification>
1. `cd agent-brain-server && poetry run pytest -x -q` — all tests pass
2. `cd agent-brain-server && poetry run mypy agent_brain_server --strict --ignore-missing-imports` — no type errors
3. `cd agent-brain-server && poetry run ruff check agent_brain_server` — no lint errors
4. `cd agent-brain-server && poetry run black --check agent_brain_server tests` — formatting correct
5. Check OpenAPI docs: `GET /index/folders` and `DELETE /index/folders` endpoints appear in schema
</verification>

<success_criteria>
- GET /index/folders returns folder list with path, chunk_count, last_indexed
- DELETE /index/folders removes folder's chunks and returns count
- DELETE /index/folders returns 409 if active job exists for that folder
- IndexRequest.include_types resolves presets to glob patterns
- include_types + include_patterns combine correctly (union)
- FolderManager initializes in lifespan and persists across restarts
- IndexingService registers folders after successful indexing
- All 686+ existing tests still pass, plus new tests
</success_criteria>

<output>
After completion, create `.planning/phases/12-folder-management-file-type-presets/12-02-SUMMARY.md`
</output>
