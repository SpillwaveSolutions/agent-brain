---
phase: 12-folder-management-file-type-presets
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - agent-brain-cli/agent_brain_cli/client/api_client.py
  - agent-brain-cli/agent_brain_cli/commands/folders.py
  - agent-brain-cli/agent_brain_cli/commands/types.py
  - agent-brain-cli/agent_brain_cli/commands/__init__.py
  - agent-brain-cli/agent_brain_cli/commands/index.py
  - agent-brain-cli/agent_brain_cli/cli.py
  - agent-brain-cli/tests/test_folders_cli.py
  - agent-brain-cli/tests/test_types_cli.py
  - agent-brain-plugin/commands/agent-brain-folders.md
  - agent-brain-plugin/commands/agent-brain-types.md
autonomous: true

must_haves:
  truths:
    - "agent-brain folders list shows indexed folders with path, chunk count, last indexed time"
    - "agent-brain folders remove /path prompts for confirmation then removes folder chunks"
    - "agent-brain folders add /path triggers indexing for that folder"
    - "agent-brain types list shows all available file type presets with extensions"
    - "agent-brain index /path --include-type python,docs passes include_types to API"
    - "--include-type and --include-patterns can be combined"
    - "All CLI commands include --help with usage examples"
    - "Plugin slash commands for folder management exist"
  artifacts:
    - path: "agent-brain-cli/agent_brain_cli/client/api_client.py"
      provides: "DocServeClient methods for folder operations"
      contains: "list_folders"
    - path: "agent-brain-cli/agent_brain_cli/commands/folders.py"
      provides: "CLI folders command group (list, add, remove)"
      exports: ["folders_group"]
    - path: "agent-brain-cli/agent_brain_cli/commands/types.py"
      provides: "CLI types list command"
      exports: ["types_command"]
    - path: "agent-brain-cli/agent_brain_cli/commands/index.py"
      provides: "Updated index command with --include-type flag"
      contains: "include_type"
    - path: "agent-brain-plugin/commands/agent-brain-folders.md"
      provides: "Plugin slash command for folder management"
    - path: "agent-brain-plugin/commands/agent-brain-types.md"
      provides: "Plugin slash command for types listing"
  key_links:
    - from: "agent-brain-cli/agent_brain_cli/commands/folders.py"
      to: "agent-brain-cli/agent_brain_cli/client/api_client.py"
      via: "DocServeClient.list_folders() / delete_folder()"
      pattern: "client\\.list_folders|client\\.delete_folder"
    - from: "agent-brain-cli/agent_brain_cli/commands/index.py"
      to: "DocServeClient.index()"
      via: "include_types parameter"
      pattern: "include_types"
---

<objective>
Create CLI commands for folder management and file type presets, extend DocServeClient with folder API methods, add --include-type flag to the index command, and create plugin slash commands.

Purpose: Completes the user-facing interface for Phase 12. Users can manage folders and use file type presets from the CLI, and Claude Code plugin users get equivalent commands.

Output: CLI commands (folders list/add/remove, types list, index --include-type), DocServeClient methods, plugin markdown files, CLI tests. Run `task before-push` to validate everything.
</objective>

<execution_context>
@/Users/richardhightower/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardhightower/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-folder-management-file-type-presets/12-RESEARCH.md
@.planning/phases/12-folder-management-file-type-presets/12-01-SUMMARY.md
@.planning/phases/12-folder-management-file-type-presets/12-02-SUMMARY.md

@agent-brain-cli/agent_brain_cli/cli.py
@agent-brain-cli/agent_brain_cli/client/api_client.py
@agent-brain-cli/agent_brain_cli/commands/__init__.py
@agent-brain-cli/agent_brain_cli/commands/index.py
@agent-brain-cli/agent_brain_cli/commands/jobs.py
@agent-brain-plugin/commands/agent-brain-index.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend DocServeClient and create CLI folders + types commands</name>
  <files>
    agent-brain-cli/agent_brain_cli/client/api_client.py
    agent-brain-cli/agent_brain_cli/commands/folders.py
    agent-brain-cli/agent_brain_cli/commands/types.py
    agent-brain-cli/agent_brain_cli/commands/__init__.py
    agent-brain-cli/agent_brain_cli/cli.py
    agent-brain-cli/tests/test_folders_cli.py
    agent-brain-cli/tests/test_types_cli.py
  </files>
  <action>
1. **Extend `client/api_client.py`** — add three methods to DocServeClient:

   a. Add a `FolderInfo` dataclass near the top (alongside existing dataclasses):
   ```python
   @dataclass
   class FolderInfo:
       folder_path: str
       chunk_count: int
       last_indexed: str
   ```

   b. `def list_folders(self) -> list[FolderInfo]`:
   - Call `self._request("GET", "/index/folders/")`
   - Parse response `data["folders"]` into list of FolderInfo objects
   - Return list

   c. `def delete_folder(self, folder_path: str) -> dict[str, Any]`:
   - Call `self._request("DELETE", "/index/folders/", json={"folder_path": folder_path})`
   - Return raw response dict (has folder_path, chunks_deleted, message)

   d. Update the `index()` method signature to accept `include_types: list[str] | None = None`:
   - Add `"include_types": include_types` to the JSON body (only if not None)

   e. Export FolderInfo from `client/__init__.py`.

2. **Create `commands/folders.py`** — Click command group with 3 subcommands:

   a. `@click.group("folders")` — `folders_group`:
   - Help text: "Manage indexed folders. List, add, or remove indexed folders."
   - Example usage in `\b` block

   b. `@folders_group.command("list")` — `list_folders_cmd`:
   - Options: `--url`, `--json` (json_output flag)
   - Get server URL from config
   - Call `client.list_folders()`
   - Rich table output: columns "Folder Path", "Chunks", "Last Indexed"
   - If no folders, print "[dim]No folders indexed yet.[/]"
   - JSON output: `json.dumps({"folders": [...]}, indent=2)`
   - Handle ConnectionError and ServerError with appropriate messages
   - `--help` shows usage examples

   c. `@folders_group.command("add")` — `add_folder_cmd`:
   - Arguments: `folder_path` (click.Path(exists=True, file_okay=False))
   - Options: `--url`, `--include-code`, `--json`
   - Resolve folder_path to absolute with `Path(folder_path).resolve()`
   - Call `client.index(folder_path=str(folder), include_code=include_code)` — this is an alias for the existing index operation (FOLD-09: idempotent)
   - Show "Indexing job queued for {folder}" message
   - Handle errors

   d. `@folders_group.command("remove")` — `remove_folder_cmd`:
   - Arguments: `folder_path` (type=str, not click.Path — the folder may already be deleted from disk)
   - Options: `--url`, `--yes` (skip confirmation), `--json`
   - Resolve folder_path to absolute with `str(Path(folder_path).resolve())`
   - Unless `--yes`, prompt: `click.confirm(f"Remove all indexed chunks for {folder}?", abort=True)`
   - Call `client.delete_folder(folder_path=resolved_path)`
   - Show "Removed {chunks_deleted} chunks for {folder}" success message
   - Handle 404 (folder not found), 409 (active job), ConnectionError, ServerError

3. **Create `commands/types.py`** — single command:

   a. `@click.command("types")` — `types_command`:
   - Options: `--json`
   - This is a LOCAL command (no server needed) — import and display FILE_TYPE_PRESETS
   - Rich table output: columns "Preset", "Extensions"
   - For each preset, show name and comma-joined patterns
   - JSON output: `json.dumps(presets, indent=2)`
   - Help text includes usage example: `agent-brain types list` (but note: "types" is the command, no subcommand "list" needed — or make it `types` as a group with `list` subcommand. Follow FTYPE-04: `agent-brain types list`. So make types a group with a "list" subcommand.)

   Actually, looking at the requirement FTYPE-04 more carefully: `agent-brain types list`. So `types` should be a Click group with a `list` subcommand:

   ```python
   @click.group("types")
   def types_group():
       """File type presets for indexing."""
       pass

   @types_group.command("list")
   def list_types_cmd(json_output):
       """List available file type presets and their extensions."""
   ```

4. **Update `commands/__init__.py`**:
   - Add `from .folders import folders_group`
   - Add `from .types import types_group`
   - Add both to `__all__`

5. **Update `cli.py`**:
   - Import `folders_group` and `types_group`
   - `cli.add_command(folders_group, name="folders")`
   - `cli.add_command(types_group, name="types")`
   - Update the help text docstring to include folders and types commands

6. **Create tests** at `tests/test_folders_cli.py`:
   - Use Click's `CliRunner` to test commands
   - Test `agent-brain folders list` with mocked client (returns folders)
   - Test `agent-brain folders list` with empty result
   - Test `agent-brain folders list --json`
   - Test `agent-brain folders remove /path --yes` with mocked client
   - Test `agent-brain folders remove /path` without --yes prompts
   - Test `agent-brain folders add /path` with mocked client
   - Mock DocServeClient using `unittest.mock.patch`

7. **Create tests** at `tests/test_types_cli.py`:
   - Test `agent-brain types list` shows table with presets
   - Test `agent-brain types list --json` outputs valid JSON
   - These tests don't need server mocking (types is local)

NOTE: The `types` command imports FILE_TYPE_PRESETS from agent-brain-server. Since the CLI and server are separate packages, the types command should either:
- Hardcode the same presets (duplication, but no cross-package dependency), OR
- Import from agent_brain_server if available, fall back to hardcoded

Preferred approach: Hardcode the presets in the CLI (they're static data) to avoid adding agent-brain-server as a CLI dependency. Add a comment noting they must stay in sync with `agent_brain_server/services/file_type_presets.py`.

All functions must have type hints. Use Google-style docstrings. Format with Black (88 chars). Must pass mypy strict.
  </action>
  <verify>
cd agent-brain-cli && poetry run pytest tests/test_folders_cli.py tests/test_types_cli.py -v && poetry run mypy agent_brain_cli/commands/folders.py agent_brain_cli/commands/types.py --strict --ignore-missing-imports
  </verify>
  <done>CLI folders (list/add/remove) and types (list) commands work, DocServeClient has folder methods, all CLI tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add --include-type flag to index command and create plugin commands</name>
  <files>
    agent-brain-cli/agent_brain_cli/commands/index.py
    agent-brain-plugin/commands/agent-brain-folders.md
    agent-brain-plugin/commands/agent-brain-types.md
  </files>
  <action>
1. **Update `commands/index.py`** — add `--include-type` option:

   Add between existing `--include-patterns` and `--exclude-patterns` options:
   ```python
   @click.option(
       "--include-type",
       "include_type",
       help="Comma-separated file type presets to include "
       "(e.g., python,docs,typescript). Use 'agent-brain types list' to see presets.",
   )
   ```

   Add `include_type: str | None` parameter to `index_command` function.

   Parse comma-separated list:
   ```python
   include_types_list = (
       [t.strip() for t in include_type.split(",")]
       if include_type
       else None
   )
   ```

   Pass to `client.index()`:
   ```python
   response = client.index(
       ...,
       include_types=include_types_list,
   )
   ```

   Update the Rich output to show include_types if specified:
   ```python
   if include_type:
       console.print(f"[bold]Include Types:[/] {include_type}")
   ```

2. **Create `agent-brain-plugin/commands/agent-brain-folders.md`** — following the pattern of existing plugin commands (see agent-brain-index.md for format):

   ```markdown
   ---
   name: agent-brain-folders
   description: Manage indexed folders
   parameters:
     - name: action
       description: Action to perform (list, add, remove)
       required: true
     - name: path
       description: Folder path (required for add/remove)
       required: false
   skills:
     - using-agent-brain
   ---

   # Manage Indexed Folders

   ## Purpose
   List, add, or remove folders from the Agent Brain index.

   ## Usage
   /agent-brain-folders list
   /agent-brain-folders add <path>
   /agent-brain-folders remove <path>

   ## Execution
   Based on the action parameter:

   **List folders:**
   ```bash
   agent-brain folders list
   ```

   **Add folder (triggers indexing):**
   ```bash
   agent-brain folders add <path>
   ```

   **Remove folder (deletes all chunks):**
   ```bash
   agent-brain folders remove <path> --yes
   ```

   ## Output
   Report the results clearly...
   [Include expected output, error handling, recovery commands]
   ```

3. **Create `agent-brain-plugin/commands/agent-brain-types.md`**:

   ```markdown
   ---
   name: agent-brain-types
   description: List available file type presets
   parameters: []
   skills:
     - using-agent-brain
   ---

   # File Type Presets

   ## Purpose
   Show available file type presets for use with --include-type flag.

   ## Usage
   /agent-brain-types

   ## Execution
   ```bash
   agent-brain types list
   ```

   ## Output
   Display the preset table...
   [Include table of presets and their extensions]
   ```

Follow the exact frontmatter and section structure of existing plugin commands in `agent-brain-plugin/commands/`.
  </action>
  <verify>
cd agent-brain-cli && poetry run pytest -x -q && poetry run mypy agent_brain_cli --strict --ignore-missing-imports && poetry run ruff check agent_brain_cli && poetry run black --check agent_brain_cli
  </verify>
  <done>index command has --include-type flag, plugin commands for folders and types exist, all CLI tests pass, quality checks clean.</done>
</task>

<task type="auto">
  <name>Task 3: Run full quality gate and verify cross-cutting requirements</name>
  <files>
    (no new files - validation only)
  </files>
  <action>
Run `task before-push` from the repository root to verify ALL requirements:

1. **XCUT-01 (both backends):** Verify delete_by_metadata exists on both ChromaBackend and PostgresBackend by checking test output.

2. **XCUT-02 (atomic writes):** Verify FolderManager tests include concurrent write test.

3. **XCUT-03 (--help):** Run and verify:
   - `cd agent-brain-cli && poetry run agent-brain folders --help`
   - `cd agent-brain-cli && poetry run agent-brain folders list --help`
   - `cd agent-brain-cli && poetry run agent-brain folders add --help`
   - `cd agent-brain-cli && poetry run agent-brain folders remove --help`
   - `cd agent-brain-cli && poetry run agent-brain types --help`
   - `cd agent-brain-cli && poetry run agent-brain types list --help`
   - `cd agent-brain-cli && poetry run agent-brain index --help` (verify --include-type appears)

4. **XCUT-04 (OpenAPI):** The FastAPI router with proper response_model annotations auto-generates OpenAPI docs. Verify by checking that Pydantic models have descriptions.

5. **XCUT-05 (test coverage):** Run `poetry run pytest --cov=agent_brain_server --cov-report=term-missing` and `poetry run pytest --cov=agent_brain_cli --cov-report=term-missing` to verify >70% coverage on new modules.

6. **XCUT-06 (before-push):** Run `task before-push` from repo root — must exit 0.

If any failures, fix them. Common issues:
- Missing type stubs — add `# type: ignore[import-untyped]` or install stubs
- Line too long — Black auto-fix: `poetry run black .`
- Import order — Ruff auto-fix: `poetry run ruff check --fix .`
  </action>
  <verify>
task before-push
  </verify>
  <done>task before-push passes with exit code 0. All 6 cross-cutting requirements verified. All --help messages include usage examples. Test coverage >70% on new modules.</done>
</task>

</tasks>

<verification>
1. `task before-push` — exits 0 (format, lint, typecheck, tests all pass)
2. `agent-brain folders list --help` — shows help with examples
3. `agent-brain folders remove --help` — shows help with examples
4. `agent-brain types list --help` — shows help with examples
5. `agent-brain index --help` — shows --include-type option
6. All 772+ existing tests still pass plus new CLI tests
</verification>

<success_criteria>
- `agent-brain folders list` renders Rich table of indexed folders
- `agent-brain folders remove /path --yes` deletes chunks and shows count
- `agent-brain folders add /path` queues indexing job
- `agent-brain types list` shows preset table (local, no server needed)
- `agent-brain index /path --include-type python,docs` passes include_types to server
- --include-type and --include-patterns combine correctly
- Plugin commands agent-brain-folders.md and agent-brain-types.md exist
- `task before-push` passes with exit code 0
- All cross-cutting requirements XCUT-01 through XCUT-06 met
</success_criteria>

<output>
After completion, create `.planning/phases/12-folder-management-file-type-presets/12-03-SUMMARY.md`
</output>
